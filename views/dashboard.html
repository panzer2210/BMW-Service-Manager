<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BMW Service Manager</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/theme-manager.js"></script>
    <script src="/js/dashboard-advanced.js"></script>
    <script src="/js/finance-calculator.js"></script>
    <script src="/js/vehicle-gallery.js"></script>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <a href="/dashboard" class="logo">ðŸš— BMW Service Manager</a>
            <ul class="nav-links">
                <li><a href="/dashboard">Dashboard</a></li>
                <li><a href="/vehicles">VehÃ­culos</a></li>
                <li><a href="/customers">Clientes</a></li>
                <li><a href="/appointments">Citas</a></li>
                <li><a href="/logout" class="btn btn-danger">Cerrar SesiÃ³n</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div class="card">
            <h1>Panel de Control</h1>
            <p>Bienvenido al sistema de gestiÃ³n BMW Service Manager</p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalVehicles">-</div>
                <div class="stat-label">VehÃ­culos Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCustomers">-</div>
                <div class="stat-label">Clientes Registrados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalAppointments">-</div>
                <div class="stat-label">Citas Totales</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="card">
            <h2>ðŸ“Š AnÃ¡lisis y Tendencias</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Ventas por Mes</h3>
                    <canvas id="salesChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h3>VehÃ­culos por Tipo</h3>
                    <canvas id="vehicleTypeChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <h2>âš¡ Acciones RÃ¡pidas</h2>
            <div class="quick-actions">
                <button class="action-btn" onclick="openQuickVehicleAdd()">
                    ðŸš— Agregar VehÃ­culo
                </button>
                <button class="action-btn" onclick="openQuickCustomerAdd()">
                    ðŸ‘¥ Nuevo Cliente
                </button>
                <button class="action-btn" onclick="generateReport()">
                    ðŸ“Š Generar Reporte
                </button>
                <button class="action-btn" onclick="openCalculator()">
                    ðŸ’° Calculadora
                </button>
                <button class="action-btn" onclick="viewNotifications()">
                    ðŸ”” Notificaciones
                    <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                </button>
                <button class="action-btn" onclick="refreshDashboard()">
                    ðŸ”„ Actualizar Dashboard
                </button>
            </div>
        </div>


        <!-- Recent Activity -->
        <div class="card">
            <h2>ðŸ“‹ Actividad Reciente</h2>
            <div id="recentActivity" class="activity-feed">
                <div class="activity-item">
                    <div class="activity-icon">ðŸš—</div>
                    <div class="activity-content">
                        <strong>Nuevo vehÃ­culo agregado</strong>
                        <p>BMW X5 2024 - Alpine White</p>
                        <span class="activity-time">Hace 2 horas</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ðŸŽ¯ Funciones Principales</h2>
            <div class="features">
                <div class="feature">
                    <div class="feature-icon">ðŸš™</div>
                    <h3>GestiÃ³n de VehÃ­culos</h3>
                    <p>Administra el inventario completo de vehÃ­culos BMW</p>
                    <a href="/vehicles" class="btn">Ver VehÃ­culos</a>
                </div>
                <div class="feature">
                    <div class="feature-icon">ðŸ‘¥</div>
                    <h3>GestiÃ³n de Clientes</h3>
                    <p>MantÃ©n el registro de todos tus clientes</p>
                    <a href="/customers" class="btn">Ver Clientes</a>
                </div>
                <div class="feature">
                    <div class="feature-icon">ðŸ“…</div>
                    <h3>Citas de Servicio</h3>
                    <p>Programa y gestiona citas de mantenimiento</p>
                    <a href="/appointments" class="btn">Ver Citas</a>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            
            // Check for updates every 3 seconds (simple and reliable)
            setInterval(() => {
                loadDashboardStats();
            }, 3000);
            
            // Also check on window focus to catch changes when switching tabs
            window.addEventListener('focus', () => {
                setTimeout(() => {
                    loadDashboardStats();
                }, 500);
            });
        });


        function checkForNewSales() {
            const saleData = localStorage.getItem('bmw-sale-completed');
            if (saleData) {
                const sale = JSON.parse(saleData);
                const lastCheck = localStorage.getItem('bmw-dashboard-last-check') || '0';
                
                // If this is a new sale (timestamp is newer than last check) or forced update
                if (sale.timestamp > parseInt(lastCheck) || sale.triggerUpdate) {
                    console.log('New sale detected in main dashboard, forcing complete update');
                    
                    // Add delay to ensure server has processed the sale
                    setTimeout(async () => {
                        console.log('Updating dashboard stats and revenue history...');
                        await loadDashboardStats();
                        await loadMonthlyRevenueHistory();
                        console.log('Dashboard update completed');
                    }, 2000);
                    
                    // Mark this sale as processed
                    localStorage.setItem('bmw-dashboard-last-check', sale.timestamp.toString());
                    
                    // Remove trigger flag
                    if (sale.triggerUpdate) {
                        delete sale.triggerUpdate;
                        localStorage.setItem('bmw-sale-completed', JSON.stringify(sale));
                    }
                }
            }
        }

        // Make function global so it can be called from other scripts
        window.loadDashboardStats = async function() {
            try {
                console.log('Loading dashboard stats...');
                const response = await fetch('/api/dashboard-stats');
                const stats = await response.json();
                
                console.log('Stats received:', stats);
                
                document.getElementById('totalVehicles').textContent = stats.totalVehicles || 0;
                document.getElementById('totalCustomers').textContent = stats.totalCustomers || 0;
                document.getElementById('totalAppointments').textContent = stats.totalAppointments || 0;
                
                console.log('Dashboard stats updated successfully');
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Create alias for backwards compatibility
        async function loadDashboardStats() {
            return await window.loadDashboardStats();
        }



        async function refreshDashboard() {
            // Clear localStorage triggers to force fresh data
            localStorage.removeItem('bmw-sale-completed');
            localStorage.removeItem('bmw-last-sale-check');
            localStorage.removeItem('bmw-dashboard-last-check');
            
            await loadDashboardStats();
            if (window.bmwDashboard) {
                await window.bmwDashboard.loadDashboardStats();
                await window.bmwDashboard.createCharts();
                window.bmwDashboard.loadRecentActivity();
            }
            alert('Â¡Dashboard actualizado exitosamente!');
        }
    </script>
</body>
</html>